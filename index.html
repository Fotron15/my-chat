<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pro IDE Social: Final Cloud Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #0d0d12; --card: #161621; --accent: #00d2ff; --text: #f0f0f0; --danger: #ff4757; --panel: #1c1c2b; --success: #2ecc71; --zip: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9000; }
        .auth-box { background: var(--card); padding: 40px; border-radius: 20px; width: 350px; text-align: center; border: 1px solid #333; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; box-sizing: border-box; font-size: 14px; outline: none; }
        
        .nav { background: #11111b; padding: 12px 25px; display: none; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .tabs button { background: none; border: none; color: #666; cursor: pointer; font-weight: bold; padding: 10px 15px; font-size: 13px; }
        .tabs button.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .screen { flex: 1; display: none; padding: 30px; overflow-y: auto; }
        .active-screen { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; }
        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #2a2a3a; cursor: pointer; transition: 0.3s; position: relative; }
        .card:hover { border-color: var(--accent); transform: translateY(-5px); }

        #ide { display: none; flex-direction: row; height: 100%; background: #1e1e1e; }
        #monaco-container { flex: 1; height: 100%; }
        .ide-sidebar { width: 260px; background: #141414; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .file-header { padding: 15px; border-bottom: 1px solid #333; background: #1a1a1a; }
        .file-list { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item { padding: 10px 12px; font-size: 13px; color: #999; cursor: pointer; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .file-item.active { background: #2d2d2d; color: var(--accent); font-weight: bold; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; z-index: 7000; overflow-y: auto; padding: 20px; }
        .modal-content { background: var(--panel); max-width: 950px; margin: 20px auto; border-radius: 20px; overflow: hidden; border: 1px solid #333; position: relative; }
        .iframe-container { width: 100%; height: 500px; background: #fff; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }

        .btn { background: var(--accent); color: #000; border: none; padding: 12px 22px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-red { background: var(--danger); color: #fff; }
        .btn-zip { background: var(--zip); color: #000; }
        .btn-mini { padding: 6px 12px; font-size: 11px; border-radius: 5px; }
        .author-link { color: var(--accent); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .fs-btn { position: absolute; top: 15px; right: 15px; z-index: 10; background: rgba(0,0,0,0.7); color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .comment { background: #1a1a2e; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #222; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h1 style="color:var(--accent)">Pro IDE Social</h1>
        <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" style="width:100%" onclick="handleAuth()">–í–•–û–î</button>
    </div>
</div>

<div class="nav" id="main-nav">
    <div class="tabs">
        <button id="tab-my" class="active" onclick="switchTab('my')">–ú–û–ò –ü–†–û–ï–ö–¢–´</button>
        <button id="tab-pub" onclick="switchTab('pub')">–ì–ê–õ–ï–†–ï–Ø</button>
    </div>
    <div id="ide-controls" style="display:none; gap:12px;">
        <button class="btn" style="background:var(--success)" onclick="runCode()">‚ñ∂ –ó–ê–ü–£–°–ö</button>
        <button class="btn" onclick="saveToCloud()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn btn-zip" onclick="downloadProjectZip()">üì¶ ZIP</button>
        <button class="btn btn-red" onclick="closeIDE()">–í–´–•–û–î</button>
    </div>
    <div style="display:flex; gap:20px; align-items:center;">
        <span id="user-display" style="font-size:14px; color:var(--accent); font-weight:bold;"></span>
        <button class="btn-red btn-mini" onclick="logout()">–í–´–ô–¢–ò</button>
    </div>
</div>

<div id="screen-my" class="screen active-screen">
    <div style="display:flex; gap:15px; margin-bottom:30px;">
        <button class="btn" onclick="createProject('simple')">üìÑ SIMPLE HTML</button>
        <button class="btn" style="background:#a55eea" onclick="createProject('advanced')">üöÄ ADVANCED (H+C+J)</button>
    </div>
    <div id="my-list" class="grid"></div>
</div>

<div id="screen-pub" class="screen">
    <button class="btn" onclick="openPublishModal()" style="background:var(--success)">üåê –í–´–õ–û–ñ–ò–¢–¨ –í –ì–ê–õ–ï–†–ï–Æ</button>
    <div id="pub-list" class="grid"></div>
</div>

<div id="ide" class="screen">
    <div class="ide-sidebar">
        <div class="file-header">
            <b style="font-size:11px; color:#555;">EXPLORER</b>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn-mini" style="flex:1" onclick="addNewFile('html')">+H</button>
                <button class="btn-mini" style="flex:1" onclick="addNewFile('css')">+C</button>
                <button class="btn-mini" style="flex:1" onclick="addNewFile('js')">+J</button>
            </div>
        </div>
        <div id="file-list" class="file-list"></div>
    </div>
    <div id="monaco-container"></div>
</div>

<div id="project-view" class="modal" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal-content">
        <div class="iframe-container">
            <button class="fs-btn" onclick="toggleFullscreen()">‚õ∂ FULLSCREEN</button>
            <iframe id="view-frame"></iframe>
        </div>
        <div style="padding:30px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="view-title" style="margin:0; color:var(--accent);"></h2>
                <div id="view-like-area"></div>
            </div>
            <p id="view-author-box">–ê–≤—Ç–æ—Ä: <span id="view-author-name" class="author-link"></span></p>
            <div id="view-desc" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; color:#ccc;"></div>
            
            <div id="author-actions" style="margin-top:20px; display:none;">
                <button class="btn btn-red btn-mini" onclick="deleteFromPublic()">üóë –£–î–ê–õ–ò–¢–¨ –ò–ó –ì–ê–õ–ï–†–ï–ò</button>
            </div>

            <div class="comment-section" style="margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="com-input" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                    <button class="btn btn-mini" onclick="addComment()">OK</button>
                </div>
                <div id="comments-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal-content" style="max-width:400px; padding:40px; text-align:center; margin: 100px auto;">
        <div style="font-size:60px;">üë§</div>
        <h2 id="prof-nick" style="color:var(--accent)"></h2>
        <div style="font-size:18px;">–ü—Ä–æ–µ–∫—Ç–æ–≤ –≤ –≥–∞–ª–µ—Ä–µ–µ: <b id="prof-count">0</b></div>
    </div>
</div>

<div id="publish-modal" class="modal" onclick="if(event.target == this) this.style.display='none'">
    <div class="modal-content" style="max-width:400px; padding:30px; margin: 100px auto;">
        <h3>–ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
        <select id="pub-select"></select>
        <textarea id="pub-desc-text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
        <button class="btn" style="width:100%" onclick="finishPublish()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
    </div>
</div>

<script>
    const DB_URL = "https://india3d-2ffac-default-rtdb.firebaseio.com/";
    let myNick = localStorage.getItem('pro_ide_nick') || "";
    let myPass = localStorage.getItem('pro_ide_pass') || "";
    let editor, activeProjId, currentFiles = {}, activeFile = "", activeProjName = "";
    let viewingPubId = null;

    const toKey = (s) => s.replace(/\./g, "_dot_");
    const fromKey = (s) => s.replace(/_dot_/g, ".");

    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });
    require(['vs/editor/editor.main'], () => {
        editor = monaco.editor.create(document.getElementById('monaco-container'), {
            theme: 'vs-dark', automaticLayout: true, fontSize: 14, minimap: { enabled: false }
        });
    });

    async function handleAuth() {
        const n = document.getElementById('auth-nick').value.trim().replace(/[.#$\[\]\s]/g, "");
        const p = document.getElementById('auth-pass').value.trim();
        if(!n || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
        const res = await fetch(`${DB_URL}accounts/${n}.json`);
        const user = await res.json();
        if(user && user.password !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        if(!user) await fetch(`${DB_URL}accounts/${n}.json`, { method: 'PUT', body: JSON.stringify({password:p}) });
        myNick = n; myPass = p;
        localStorage.setItem('pro_ide_nick', n); localStorage.setItem('pro_ide_pass', p);
        startSession(n);
    }

    function startSession(n) {
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('main-nav').style.display='flex';
        document.getElementById('user-display').innerText = n;
        switchTab('my');
    }

    function logout() { localStorage.clear(); location.reload(); }
    window.onload = () => { if(myNick && myPass) startSession(myNick); };

    function switchTab(t) {
        document.querySelectorAll('.screen').forEach(s => s.style.display='none');
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('ide-controls').style.display = 'none';
        if(t==='my') { document.getElementById('screen-my').style.display='block'; loadMy(); document.getElementById('tab-my').classList.add('active'); }
        else { document.getElementById('screen-pub').style.display='block'; loadPub(); document.getElementById('tab-pub').classList.add('active'); }
    }

    async function createProject(type) {
        const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:"); if(!n) return;
        const id = 'p' + Date.now();
        let files = {};
        files[toKey("index.html")] = `<h1>${n}</h1>`;
        if(type==='advanced') { files[toKey("style.css")] = "body{background:#111;color:#00d2ff;}"; files[toKey("script.js")] = "console.log('IDE');"; }
        await fetch(`${DB_URL}users/${myNick}/${id}.json`, { method: 'PUT', body: JSON.stringify({name:n, files, author:myNick}) });
        loadMy();
    }

    async function loadMy() {
        const res = await fetch(`${DB_URL}users/${myNick}.json`);
        const data = await res.json();
        const list = document.getElementById('my-list'); list.innerHTML = "";
        for(let id in data) {
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<h3>${data[id].name}</h3><button class="btn btn-red btn-mini" onclick="deleteMy(event,'${id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
            card.onclick = () => openIDE(id, data[id]);
            list.appendChild(card);
        }
    }

    async function deleteMy(e, id) { e.stopPropagation(); if(confirm("–£–¥–∞–ª–∏—Ç—å –ª–∏—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç?")) { await fetch(`${DB_URL}users/${myNick}/${id}.json`, { method: 'DELETE' }); loadMy(); } }

    function openIDE(id, project) {
        activeProjId = id; activeProjName = project.name; currentFiles = project.files || {};
        document.querySelectorAll('.screen').forEach(s => s.style.display='none');
        document.getElementById('ide').style.display = 'flex';
        document.getElementById('ide-controls').style.display = 'flex';
        renderFileList(); switchFile(Object.keys(currentFiles)[0]);
    }

    function renderFileList() {
        const list = document.getElementById('file-list'); list.innerHTML = "";
        for(let fKey in currentFiles) {
            const item = document.createElement('div');
            item.className = 'file-item' + (activeFile === fKey ? ' active' : '');
            item.innerHTML = `<span>üìÑ ${fromKey(fKey)}</span><span onclick="deleteFile(event,'${fKey}')">‚úï</span>`;
            item.onclick = () => switchFile(fKey);
            list.appendChild(item);
        }
    }

    function switchFile(fKey) {
        if(activeFile) currentFiles[activeFile] = editor.getValue();
        activeFile = fKey;
        const ext = fromKey(fKey).split('.').pop();
        monaco.editor.setModelLanguage(editor.getModel(), ext==='js'?'javascript':ext==='css'?'css':'html');
        editor.setValue(currentFiles[fKey] || "");
        renderFileList();
    }

    function addNewFile(t) {
        const n = prompt("–ò–º—è —Ñ–∞–π–ª–∞:"); if(!n) return;
        const fKey = toKey(n + '.' + t);
        currentFiles[fKey] = ""; switchFile(fKey);
    }

    function deleteFile(e, fKey) { e.stopPropagation(); delete currentFiles[fKey]; switchFile(Object.keys(currentFiles)[0]); }

    async function saveToCloud() {
        currentFiles[activeFile] = editor.getValue();
        await fetch(`${DB_URL}users/${myNick}/${activeProjId}/files.json`, { method: 'PUT', body: JSON.stringify(currentFiles) });
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    }

    // ZIP FIXED
    function downloadProjectZip() {
        if(typeof JSZip === 'undefined') return alert("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –µ—â–µ –≥—Ä—É–∑–∏—Ç—Å—è...");
        currentFiles[activeFile] = editor.getValue();
        const zip = new JSZip();
        for (let fKey in currentFiles) zip.file(fromKey(fKey), currentFiles[fKey]);
        zip.generateAsync({type:"blob"}).then(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${activeProjName}.zip`;
            a.click();
        });
    }

    function runCode() {
        currentFiles[activeFile] = editor.getValue();
        let code = currentFiles[toKey("index.html")] || "";
        for(let f in currentFiles) {
            if(fromKey(f).endsWith('.css')) code += `<style>${currentFiles[f]}</style>`;
            if(fromKey(f).endsWith('.js')) code += `<script>${currentFiles[f]}<\/script>`;
        }
        document.getElementById('project-view').style.display='block';
        document.getElementById('view-frame').srcdoc = code;
        document.getElementById('view-author-box').style.display = 'none';
        document.getElementById('author-actions').style.display = 'none';
    }

    function toggleFullscreen() {
        const ifr = document.getElementById('view-frame');
        if (ifr.requestFullscreen) ifr.requestFullscreen();
        else if (ifr.webkitRequestFullscreen) ifr.webkitRequestFullscreen();
    }

    function closeIDE() { activeProjId = null; switchTab('my'); }

    async function loadPub() {
        const res = await fetch(`${DB_URL}public.json`);
        const data = await res.json();
        const list = document.getElementById('pub-list'); list.innerHTML = "";
        if(!data) return;
        for(let id in data) {
            const p = data[id];
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<h3>${p.name}</h3><p>–ê–≤—Ç–æ—Ä: <span class="author-link" onclick="event.stopPropagation(); showProfile('${p.author}')">${p.author}</span></p>`;
            card.onclick = () => openPublicProject(id, p);
            list.appendChild(card);
        }
    }

    function openPublicProject(id, p) {
        viewingPubId = id;
        document.getElementById('project-view').style.display='block';
        document.getElementById('view-author-box').style.display = 'block';
        document.getElementById('author-actions').style.display = (p.author === myNick) ? 'block' : 'none';
        
        let code = p.files[toKey("index.html")] || "";
        for(let fKey in p.files) {
            if(fromKey(fKey).endsWith('.css')) code += `<style>${p.files[fKey]}</style>`;
            if(fromKey(fKey).endsWith('.js')) code += `<script>${p.files[fKey]}<\/script>`;
        }
        document.getElementById('view-frame').srcdoc = code;
        document.getElementById('view-title').innerText = p.name;
        document.getElementById('view-author-name').innerText = p.author;
        document.getElementById('view-desc').innerText = p.desc || "";
        renderLikes(p); loadComments(id);
    }

    async function deleteFromPublic() {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ –æ–±—â–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞?")) return;
        await fetch(`${DB_URL}public/${viewingPubId}.json`, { method: 'DELETE' });
        document.getElementById('project-view').style.display = 'none';
        loadPub();
    }

    async function showProfile(nick) {
        const res = await fetch(`${DB_URL}public.json`);
        const data = await res.json();
        let count = 0;
        for(let id in data) if(data[id].author === nick) count++;
        document.getElementById('prof-nick').innerText = nick;
        document.getElementById('prof-count').innerText = count;
        document.getElementById('profile-modal').style.display = 'block';
    }

    function renderLikes(p) {
        const c = p.likes ? Object.keys(p.likes).length : 0;
        document.getElementById('view-like-area').innerHTML = `<button class="btn btn-mini" onclick="likePub('${viewingPubId}')">‚ù§Ô∏è ${c}</button>`;
    }

    async function likePub(id) {
        await fetch(`${DB_URL}public/${id}/likes/${myNick}.json`, { method: 'PUT', body: "true" });
        const res = await fetch(`${DB_URL}public/${id}.json`);
        renderLikes(await res.json());
    }

    async function openPublishModal() {
        const res = await fetch(`${DB_URL}users/${myNick}.json`);
        const projs = await res.json();
        const sel = document.getElementById('pub-select'); sel.innerHTML = "";
        for(let id in projs) sel.innerHTML += `<option value="${id}">${projs[id].name}</option>`;
        document.getElementById('publish-modal').style.display='block';
    }

    async function finishPublish() {
        const id = document.getElementById('pub-select').value;
        const d = document.getElementById('pub-desc-text').value;
        const res = await fetch(`${DB_URL}users/${myNick}/${id}.json`);
        const proj = await res.json();
        await fetch(`${DB_URL}public/${'pub'+Date.now()}.json`, { method: 'PUT', body: JSON.stringify({...proj, desc: d}) });
        alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!"); document.getElementById('publish-modal').style.display='none'; loadPub();
    }

    async function loadComments(id) {
        const res = await fetch(`${DB_URL}public/${id}/comments.json`);
        const data = await res.json();
        const list = document.getElementById('comments-list'); list.innerHTML = "";
        if(!data) return;
        for(let cid in data) list.innerHTML += `<div class="comment"><b>${data[cid].user}:</b> ${data[cid].text}</div>`;
    }

    async function addComment() {
        const t = document.getElementById('com-input').value; if(!t) return;
        await fetch(`${DB_URL}public/${viewingPubId}/comments.json`, { method: 'POST', body: JSON.stringify({user:myNick, text:t}) });
        document.getElementById('com-input').value = ""; loadComments(viewingPubId);
    }
</script>
</body>
</html>
