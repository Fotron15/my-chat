<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pro IDE Social</title>
    <style>
        :root { --bg: #0d0d12; --card: #161621; --accent: #00d2ff; --text: #f0f0f0; --danger: #ff4757; --panel: #1c1c2b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Auth & Nav */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9000; }
        .auth-box { background: var(--card); padding: 30px; border-radius: 15px; width: 320px; text-align: center; border: 1px solid #333; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #444; background: #000; color: #fff; box-sizing: border-box; }
        .nav { background: #11111b; padding: 10px 20px; display: none; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .tabs button { background: none; border: none; color: #777; cursor: pointer; font-weight: bold; padding: 10px; font-size: 13px; }
        .tabs button.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        /* Grid */
        .screen { flex: 1; display: none; padding: 25px; overflow-y: auto; }
        .active-screen { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #2a2a3a; cursor: pointer; transition: 0.2s; }
        .card:hover { border-color: var(--accent); }

        /* Preview Modal */
        #project-view { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 7000; overflow-y: auto; padding: 20px; }
        .view-content { background: var(--panel); max-width: 800px; margin: 0 auto; border-radius: 15px; overflow: hidden; position: relative; }
        .iframe-container { width: 100%; height: 400px; background: #fff; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        .view-info { padding: 20px; }
        .full-btn { position: absolute; top: 10px; right: 10px; padding: 5px 10px; background: rgba(0,0,0,0.5); color: #fff; cursor: pointer; border-radius: 5px; font-size: 12px; }

        /* Comments */
        .comment-section { margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .comment { background: #111; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
        .reply { margin-left: 30px; border-left: 2px solid var(--accent); padding-left: 10px; margin-top: 5px; }
        .com-author { color: var(--accent); font-weight: bold; font-size: 12px; }
        .com-btn { color: #888; font-size: 11px; cursor: pointer; margin-left: 10px; text-decoration: underline; }

        /* Buttons */
        .btn { background: var(--accent); color: #000; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--danger); color: #fff; }
        .btn-mini { padding: 5px 10px; font-size: 11px; }

        #ide { display: none; height: 100%; background: #1e1e1e; }
        #editor { width: 100%; height: 100%; background: transparent; color: #d4d4d4; border: none; padding: 20px; font-family: monospace; outline: none; resize: none; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--accent)">Pro IDE Social</h2>
        <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" style="width:100%" onclick="handleAuth()">–í–æ–π—Ç–∏</button>
        <p id="auth-status" style="font-size:11px; color: #888; margin-top:15px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
</div>

<div class="nav" id="main-nav">
    <div class="tabs">
        <button id="tab-my" class="active" onclick="switchTab('my')">–ú–û–ò –ü–†–û–ï–ö–¢–´</button>
        <button id="tab-pub" onclick="switchTab('pub')">–ì–ê–õ–ï–†–ï–Ø</button>
    </div>
    <div id="ide-controls" style="display:none; gap:10px;">
        <button class="btn" onclick="saveToCloud()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn btn-red" onclick="closeIDE()">–í–´–•–û–î</button>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <span id="user-display" style="font-size:12px; color:var(--accent)"></span>
        <button class="btn-red btn-mini" onclick="logout()">–í–´–ô–¢–ò</button>
    </div>
</div>

<div id="screen-my" class="screen active-screen">
    <button class="btn" onclick="createProject()">+ –ù–û–í–´–ô –ü–†–û–ï–ö–¢</button>
    <div id="my-list" class="grid"></div>
</div>

<div id="screen-pub" class="screen">
    <button class="btn" onclick="publishMenu()" style="background:#2ecc71">üåê –í–´–õ–û–ñ–ò–¢–¨ –ü–†–û–ï–ö–¢</button>
    <div id="pub-list" class="grid"></div>
</div>

<div id="ide" class="screen"><textarea id="editor" spellcheck="false"></textarea></div>

<div id="project-view" onclick="if(event.target == this) this.style.display='none'">
    <div class="view-content">
        <div class="iframe-container">
            <iframe id="view-frame"></iframe>
            <div class="full-btn" onclick="goFull()">–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω ‚õ∂</div>
        </div>
        <div class="view-info">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="view-title" style="margin:0; color:var(--accent);"></h2>
                <div id="view-like-area"></div>
            </div>
            <p id="view-author" style="color:#888; font-size:12px;"></p>
            <p id="view-desc" style="background:#111; padding:10px; border-radius:5px;"></p>
            
            <div class="comment-section">
                <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="com-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                    <button class="btn btn-mini" onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
                <div id="comments-list"></div>
            </div>
        </div>
        <button class="btn btn-red" style="width:100%; border-radius:0;" onclick="document.getElementById('project-view').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    const DB_URL = "https://india3d-2ffac-default-rtdb.firebaseio.com/";
    let myNick = localStorage.getItem('pro_ide_nick') || "";
    let myPass = localStorage.getItem('pro_ide_pass') || "";
    let activeProjId = null;
    let viewingPubId = null;

    window.onload = () => { if(myNick && myPass) checkAutoLogin(); };

    async function checkAutoLogin() {
        const res = await fetch(`${DB_URL}accounts/${myNick}.json`);
        const user = await res.json();
        if(user && user.password === myPass) startSession(myNick);
        else logout();
    }

    async function handleAuth() {
        const nick = document.getElementById('auth-nick').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if(!nick || !pass) return;
        const res = await fetch(`${DB_URL}accounts/${nick}.json`);
        const user = await res.json();
        if(user) {
            if(user.password === pass) login(nick, pass);
            else alert("–û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è");
        } else {
            await fetch(`${DB_URL}accounts/${nick}.json`, { method: 'PUT', body: JSON.stringify({password:pass}) });
            login(nick, pass);
        }
    }

    function login(n, p) { localStorage.setItem('pro_ide_nick', n); localStorage.setItem('pro_ide_pass', p); myNick = n; myPass = p; startSession(n); }
    function logout() { localStorage.clear(); location.reload(); }
    function startSession(n) { document.getElementById('auth-screen').style.display='none'; document.getElementById('main-nav').style.display='flex'; document.getElementById('user-display').innerText = "üë§ "+n; switchTab('my'); }

    function switchTab(t) {
        document.querySelectorAll('.screen').forEach(s => s.style.display='none');
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        if(t==='my') { document.getElementById('screen-my').style.display='block'; loadMy(); document.getElementById('tab-my').classList.add('active'); }
        else { document.getElementById('screen-pub').style.display='block'; loadPub(); document.getElementById('tab-pub').classList.add('active'); }
    }

    async function createProject() {
        const n = prompt("–ò–º—è –ø—Ä–æ–µ–∫—Ç–∞:"); if(!n) return;
        const id = 'p'+Date.now();
        await fetch(`${DB_URL}users/${myNick}/${id}.json`, { method: 'PUT', body: JSON.stringify({name:n, code:"<h1>"+n+"</h1>", author:myNick}) });
        loadMy();
    }

    async function loadMy() {
        const res = await fetch(`${DB_URL}users/${myNick}.json`);
        const data = await res.json();
        const list = document.getElementById('my-list'); list.innerHTML = "";
        for(let id in data) {
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<h3>${data[id].name}</h3><button class="btn btn-red btn-mini" style="margin-top:10px" onclick="deleteMy(event,'${id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
            card.onclick = () => { activeProjId = id; document.getElementById('screen-my').style.display='none'; document.getElementById('ide').style.display='flex'; document.getElementById('ide-controls').style.display='flex'; document.getElementById('editor').value = data[id].code; };
            list.appendChild(card);
        }
    }

    async function deleteMy(e, id) { e.stopPropagation(); await fetch(`${DB_URL}users/${myNick}/${id}.json`, { method: 'DELETE' }); loadMy(); }
    async function saveToCloud() { await fetch(`${DB_URL}users/${myNick}/${activeProjId}/code.json`, { method: 'PUT', body: JSON.stringify(document.getElementById('editor').value) }); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); }
    function closeIDE() { activeProjId = null; switchTab('my'); }

    async function loadPub() {
        const res = await fetch(`${DB_URL}public.json`);
        const data = await res.json();
        const list = document.getElementById('pub-list'); list.innerHTML = "";
        for(let id in data) {
            const p = data[id];
            const likes = p.likes ? Object.keys(p.likes).length : 0;
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<h3>${p.name}</h3><p>–ê–≤—Ç–æ—Ä: ${p.author}</p><div style="color:var(--accent); font-size:12px;">‚ù§Ô∏è ${likes}</div>`;
            card.onclick = () => openProjectView(id, p);
            list.appendChild(card);
        }
    }

    function openProjectView(id, p) {
        viewingPubId = id;
        document.getElementById('project-view').style.display = 'block';
        document.getElementById('view-frame').srcdoc = p.code;
        document.getElementById('view-title').innerText = p.name;
        document.getElementById('view-author').innerText = "–ê–≤—Ç–æ—Ä: " + p.author;
        document.getElementById('view-desc').innerText = p.desc || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
        renderLikes(p);
        loadComments(id);
    }

    function renderLikes(p) {
        const count = p.likes ? Object.keys(p.likes).length : 0;
        document.getElementById('view-like-area').innerHTML = `<button class="btn btn-mini" onclick="likePub('${viewingPubId}')">‚ù§Ô∏è ${count}</button>`;
    }

    async function likePub(id) { await fetch(`${DB_URL}public/${id}/likes/${myNick}.json`, { method: 'PUT', body: "true" }); const res = await fetch(`${DB_URL}public/${id}.json`); const p = await res.json(); renderLikes(p); loadPub(); }

    function goFull() { const f = document.getElementById('view-frame'); if(f.requestFullscreen) f.requestFullscreen(); }

    async function loadComments(id) {
        const res = await fetch(`${DB_URL}public/${id}/comments.json`);
        const data = await res.json();
        const list = document.getElementById('comments-list'); list.innerHTML = "";
        for(let cid in data) {
            const c = data[cid];
            const div = document.createElement('div'); div.className = 'comment';
            div.innerHTML = `<span class="com-author">${c.user}:</span> <span>${c.text}</span>
                <span class="com-btn" onclick="replyTo('${cid}')">–û—Ç–≤–µ—Ç–∏—Ç—å</span>`;
            if(c.replies) {
                for(let rid in c.replies) {
                    const r = c.replies[rid];
                    div.innerHTML += `<div class="reply"><span class="com-author">${r.user}:</span> ${r.text}</div>`;
                }
            }
            list.appendChild(div);
        }
    }

    async function addComment() {
        const text = document.getElementById('com-input').value; if(!text) return;
        await fetch(`${DB_URL}public/${viewingPubId}/comments.json`, { method: 'POST', body: JSON.stringify({user:myNick, text}) });
        document.getElementById('com-input').value = ""; loadComments(viewingPubId);
    }

    async function replyTo(cid) {
        const text = prompt("–í–∞—à –æ—Ç–≤–µ—Ç:"); if(!text) return;
        await fetch(`${DB_URL}public/${viewingPubId}/comments/${cid}/replies.json`, { method: 'POST', body: JSON.stringify({user:myNick, text}) });
        loadComments(viewingPubId);
    }

    async function publishMenu() {
        const res = await fetch(`${DB_URL}users/${myNick}.json`);
        const projects = await res.json();
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:\n" + Object.values(projects || {}).map(p=>p.name).join(", "));
        const pId = Object.keys(projects || {}).find(k => projects[k].name === name);
        if(pId) {
            const desc = prompt("–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:");
            const pubData = { ...projects[pId], desc, author: myNick };
            await fetch(`${DB_URL}public.json`, { method: 'POST', body: JSON.stringify(pubData) });
            alert("–ì–æ—Ç–æ–≤–æ!"); loadPub();
        }
    }
</script>
</body>
</html>
